/*	Retro Context for HTML5 Canvas. Version 0.4 ALPHA
 *	Copyright (c) 2013-2014 Epistemex
 *	Licensed under GPL 3.0
 */
var retro={version:"0.4 ALPHA"};"use strict";retro.Context=function(q){var Z=this,ar=q.dataset.width||q.width,aq=q.dataset.height||q.height,k=document.createElement("canvas"),m=k.getContext("2d",{alpha:!1}),ad=document.createElement("canvas"),ae=ad.getContext("2d",{alpha:!1}),p,M,i,j,al,am,au,av,f=!0,at=!0,ah,r,g,ai=-1,t=-1,h=-1,s="rgba(0,0,0,0)",aj=null,aF=!1,aE,ag,u=[],n=null,aA="left",aB="top",o=null,Y,aC=0,aD=0,an,Q,ay=a,az=d;ar=((ar/8)|0)*8;if(ar<8||aq<1){throw"Invalid resolution."}au=ar/q.width;av=aq/q.height;k.width=ar;k.height=aq;ad.width=ar;ad.height=aq;P();O();q.addEventListener("resize",O,!1);al=k.width;am=k.height;this.context=m;this.initCanvas=function(){O();l();return this};this.resolution=function(aH,aG){if(arguments.length===0){return{width:al,height:am}}if(al<1||am<1){throw"Invalid resolution."}al=((aH/8)|0)*8;am=aG|0;k.width=al;k.height=am;ad.width=al;ad.height=am;au=al/q.width;av=am/q.height;v(al,am,!1);l();return this};this.commit=function(aG){aG=T(aG)?aG:!1;l(aG);return this};this.autoCommit=function(aG){if(!T(aG)){return f}f=aG;return this};this.safeMode=function(aG){if(!T(aG)){return at}ay=aG?a:b;this.setPixel=ay;at=aG;return this};this.getImageData=function(aI,aJ,aH,aG){if(arguments.length===0){return M}return m.getImageData(aI,aJ,aH,aG)};this.putImageData=function(aG,aH,aI){if(arguments.length===0){M=aG;if(f){l()}}else{m.putImageData(M,aH,aI);if(f){l(!0)}}return this};this.toDataURL=function(aL,aJ){var aG=document.createElement("canvas"),aI=aG.getContext("2d"),aK=this.resolution(),aH;aG.width=aK.width;aG.height=aK.height;l(!0);if(g){aH=Q(g);aI.fillStyle=(new retro.Color(aH[0],aH[1],aH[2])).toStyle();aI.fillRect(0,0,aK.width,aK.height)}aI.drawImage(k,0,0);return aI.canvas.toDataURL.apply(aI.canvas,arguments)};this.updateRegion=function(aL,aM,aK,aG){var aI=q.width/al,aJ=q.height/am,aH=p.globalCompositeOperation;p.globalCompositeOperation="source-over";p.drawImage(k,aL,aM,aK,aG,aL*aI,aM*aJ,aK*aI,aG*aJ);p.globalCompositeOperation=aH;return this};this.palette=function(aG){if(arguments.length===0){return o}if(aG instanceof retro.Palette){o=aG;Y=aG.lut}else{if(Array.isArray(aG)||X(aG)){aG=new retro.Palette(aG);o=aG;Y=aG.lut}else{o=Y=null}}return this};this.penColor=function(aJ,aI,aG){var aH;if(arguments.length===0){if(ah===null){return null}else{aH=Q(ah);return new retro.Color(aH[0],aH[1],aH[2])}}else{if(arguments.length===3){ah=an(aJ,aI,aG)}else{if(aJ instanceof retro.Color){ah=aJ.toInt()}else{ah=null}}}ai=-1;return this};this.penIndex=function(aG){if(arguments.length===0){return ai}if(o){if(aG<0){ah=null;ai=-1}else{ah=o._lutCache[aG];ai=aG}}return this};this.fillColor=function(aJ,aI,aG){var aH;if(arguments.length===0){if(r===null){return null}else{aH=Q(r);return new retro.Color(aH[0],aH[1],aH[2])}}else{if(arguments.length===3){r=an(aJ,aI,aG);s="rgb("+aJ+","+aI+","+aG+")"}else{if(aJ instanceof retro.Color){r=aJ.toInt();s="rgb("+aJ.r+","+aJ.g+","+aJ.b+")"}else{r=null}}}t=-1;return this};this.fillIndex=function(aH){var aG;if(arguments.length===0){return t}if(o){if(aH<0){r=null;t=-1;s="transparent"}else{r=o._lutCache[aH];t=aH;aG=o.lut[aH];s="rgb("+aG[0]+","+aG[1]+","+aG[2]+")"}}return this};this.bgColor=function(aK,aJ,aG){var aH,aI;if(arguments.length===0){if(g===null){return null}else{aH=Q(g);return new retro.Color(aH[0],aH[1],aH[2])}}else{if(arguments.length===3){g=an(aK,aJ,aG)}else{if(aK instanceof retro.Color){g=aK.toInt()}else{g=null}}}h=-1;if(g!==null){aH=Q(g);aI="rgb("+aH[0]+","+aH[1]+","+aH[2]+")"}else{aI="transparent"}q.style.backgroundColor=aI;return this};this.bgIndex=function(aI){var aG,aH;if(arguments.length===0){return h}if(o){if(aI<0){g=null;h=-1;aH="transparent"}else{g=o._lutCache[aI];h=aI;aG=o.lut[aI];aH="rgb("+aG[0]+","+aG[1]+","+aG[2]+")"}}q.style.backgroundColor=aH;return this};this.clear=function(){v(al,am,!1);if(f){l()}return this};this.clearRect=function(aN,aP,aM,aH){aN+=aC;aP+=aD;var aK,aL=aP,aO=aN+aM,aQ=((aH*0.5)|0)*2+aL,aG=aP+aH,aI,aJ;for(;aL<aQ;aL+=2){aI=aL*al;aJ=aI+al;for(aK=aN;aK<aO;aK++){j[aI+aK]=0;j[aJ+aK]=0}}if(aL<aG){aI=aL*al;for(aK=aN;aK<aO;aK++){j[aI+aK]=0}}if(f){l()}return this};this.fillBackground=function(){var aG=0,aH=j.length;for(;aG<aH;aG+=8){j[aG]=r;j[aG+1]=r;j[aG+2]=r;j[aG+3]=r;j[aG+4]=r;j[aG+5]=r;j[aG+6]=r;j[aG+7]=r}if(f){l()}return this};this.replaceColor=function(aM,aJ,aG){var aK=0,aH,aL,aI;if(arguments.length===1){if(aM instanceof retro.Color){aJ=aM.g;aG=aM.b;aM=aM.r}else{if(V(aM)){aH=o.getColor(aM);aM=aH.r;aJ=aH.g;aG=aH.b}else{}}}aL=j.length;aI=an(aM,aJ,aG);for(;aK<aL;aK+=8){if(j[aK]===aI){j[aK]=r}if(j[aK+1]===aI){j[aK+1]=r}if(j[aK+2]===aI){j[aK+2]=r}if(j[aK+3]===aI){j[aK+3]=r}if(j[aK+4]===aI){j[aK+4]=r}if(j[aK+5]===aI){j[aK+5]=r}if(j[aK+6]===aI){j[aK+6]=r}if(j[aK+7]===aI){j[aK+7]=r}}if(f){l()}return this};this.line=function(aN,aP,aO,aQ){aN|=0;aO|=0;aP|=0;aQ|=0;var aG,aK,aL=aQ-aP,aI=aO-aN,aR=!1,aJ=aI>>31,aM=aL>>31,aH;if((aL^aM)-aM>(aI^aJ)-aJ){aL^=aI;aI^=aL;aL^=aI;aR=!0}aG=aI<0?-1:1;aK=(aI===0)?aL:aL/aI;if(aR){aN+=0.5;for(aH=0;aH!==aI;aH+=aG){ay((aN+aH*aK)|0,aP+aH)}}else{aP+=0.5;for(aH=0;aH!==aI;aH+=aG){ay(aN+aH,(aP+aH*aK)|0)}}ay(aO,aQ);if(f){l()}return this};this.lines=function(aJ){var aK,aL,aM,aN,aH=2,aI=aJ.length,aG=this.autoCommit();this.autoCommit(!1);aK=aJ[0];aL=aJ[1];for(;aH<aI;aH+=2){aM=aJ[aH];aN=aJ[aH+1];Z.line(aK,aL,aM,aN);aK=aM;aL=aN}this.autoCommit(aG);if(f){l()}return this};this.circle=function(aP,aS,aL){if(aL<1){return this}aP|=0;aS|=0;aL|=0;var aO=aL,aR=0,aH=0,aQ=0,aT=aL,aG=-aL,aJ,aK,aM,aN;if(r!==null){while(aQ<=aT){aJ=aP-aQ;aK=aP-aT;aM=aQ+aQ;aN=aT+aT;aI(aJ,aS-aT,aS+aT,aM);aI(aK,aS-aQ,aS+aQ,aN);if((aG+=aQ+++aQ)>=0){aG-=--aT+aT}}}if(ah===null){if(f){l()}return this}ay(aP-aL,aS);ay(aP+aL,aS);ay(aP,aS-aL);ay(aP,aS+aL);while(aO>aR){aH-=(--aO)-(++aR);if(aH<0){aH+=aO++}ay(aP-aO,aS-aR);ay(aP-aR,aS-aO);ay(aP+aR,aS-aO);ay(aP+aO,aS-aR);ay(aP-aO,aS+aR);ay(aP-aR,aS+aO);ay(aP+aR,aS+aO);ay(aP+aO,aS+aR)}if(f){l()}function aI(aV,aX,aY,aU){aU++;var aW=0;while(aU--){aW=aV+aU;az(aW,aX);az(aW,aY)}}return this};this.ellipse=function(aS,aV,aP,aQ){aP=(aP|0)-1;aQ=(aQ|0)-1;if(aP<=0||aQ<=0){return this}var aT=aS-aP,aW=aV-aQ,aU=aS+aP,aR=aP<<1,aL=aQ<<1,aM=aL&1,aH=((1-aR)*aL*aL)<<2,aI=((aM+1)*aR*aR)<<2,aK=aH+aI+aM*aR*aR,aG=(r!==null),aJ,aO,aX;aW+=(aL+1)>>1;aX=aW-aM;aR*=aR<<3;aM=(aL*aL)<<3;if(aG===!0){do{aO=((aS-aT+0.5)*2-2)|0;if(aO>0){aN(aT+1,aX,aO);aN(aT+1,aW,aO)}ay(aU,aW);ay(aT,aW);ay(aT,aX);ay(aU,aX);aJ=aK<<1;if(aJ<=aI){aW++;aX--;aK+=aI+=aR}if(aJ>=aH||aK<<1>aI){aT++;aU--;aK+=aH+=aM}}while(aT<=aU)}else{do{ay(aU,aW);ay(aT,aW);ay(aT,aX);ay(aU,aX);aJ=aK<<1;if(aJ<=aI){aW++;aX--;aK+=aI+=aR}if(aJ>=aH||aK<<1>aI){aT++;aU--;aK+=aH+=aM}}while(aT<=aU)}while(aW-aX<aL){ay(aT-1,aW);ay(aU+1,aW++);ay(aT-1,aX);ay(aU+1,aX--)}if(f){l()}function aN(aZ,a0,aY){while(aY--){az(aZ+aY,a0)}}return this};this.rect=function(aO,aQ,aM,aG){aO|=0;aQ|=0;aM|=0;aG|=0;if(aM<0){aO+=aM;aM=-aM}if(aG<0){aQ+=aG;aG=-aG}aM--;aG--;var aJ=aQ+aG,aK;if(r!==null){if(ah){var aP=aO+1,aN=aM-1;for(aK=aQ+1;aK<aJ;aK++){aI(aP,aK,aN)}}else{for(aK=aQ;aK<=aJ;aK++){aI(aO,aK,aM)}}}if(ah!==null){aH(aO,aQ,aJ,aM);aL(aO,aO+aM,aQ,aG+1)}if(f){l()}function aH(aS,aT,aU,aR){while(aR--){ay(aS+aR,aT);ay(aS+aR,aU)}}function aL(aS,aT,aU,aR){while(aR--){ay(aS,aU+aR);ay(aT,aU+aR)}}function aI(aS,aT,aR){aR++;while(aR--){az(aS+aR,aT)}}return this};this.polygon=function(aI){var aG,aL=aI.slice(),aH=aL.length,aJ=aL[0],aK=aL[1];if(r!==null){ae.translate(0.5+aC,0.5+aD);ae.fillStyle=s;ae.moveTo(aJ,aK);for(aG=2;aG<aH;aG+=2){ae.lineTo(aL[aG],aL[aG+1])}ae.fill();ab(r)}aL.push(aL[0],aL[1]);if(ah===null){if(f){l()}}else{this.lines(aL)}return this};this.arc=function(aI,aJ,aM,aO,aK,aH){if(aM===0||aO===aK){return this}if(aO>aK){var aQ=aK;aK=aO;aO=aQ}aH=T(aH)?aH:!1;var aP=0.02,aL=[],aG=aH?aK:aO,aN,aR,aS;if(aH){aO=aN=Math.PI*2-aO;for(;aG<aO;aG+=aP){aR=(aI+aM*Math.cos(aG)+0.5)|0;aS=(aJ+aM*Math.sin(aG)+0.5)|0;aL.push(aR,aS)}}else{for(;aG<aK+aP;aG+=aP){aR=(aI+aM*Math.cos(aG)+0.5)|0;aS=(aJ+aM*Math.sin(aG)+0.5)|0;aL.push(aR,aS)}aN=aK}aR=(aI+aM*Math.cos(aN)+0.5)|0;aS=(aJ+aM*Math.sin(aN)+0.5)|0;aL.push(aR,aS);this.lines(aL);return this};this.curveQuadratic=function(aO,aP,aG,aH,aI,aJ){var aM=[],aN=0.025,aK=aN;aM.push((aO+0.5)|0,(aP+0.5)|0);for(;aK<1;aK+=aN){aL(aO,aP,aG,aH,aI,aJ,aK)}aM.push((aI+0.5)|0,(aJ+0.5)|0);function aL(aZ,a0,aQ,aR,a1,a2,aS){var aT=(1-aS),aU=aT*aT,aV=aS*aS,aW=2*aT*aS,aX,aY;aX=(aU*aZ+aW*aQ+aV*a1+0.5|0);aY=(aU*a0+aW*aR+aV*a2+0.5|0);aM.push(aX,aY)}return this.lines(aM)};this.curveBezier=function(aQ,aR,aG,aH,aI,aJ,aK,aL){var aO=[],aP=0.025,aM=aP;aO.push(aQ,aR);for(;aM<1;aM+=aP){aN(aQ,aR,aG,aH,aI,aJ,aK,aL,aM)}aO.push(aK,aL);function aN(a6,a7,aS,aT,aU,aV,a8,a9,aW){var aZ=1-aW,a0=aZ*aZ,a1=a0*aZ,aX=aW*aW,aY=aX*aW,a3=aW*3*a0,a2=aX*3*aZ,a4,a5;a4=(a1*a6+a3*aS+a2*aU+aY*a8+0.5)|0;a5=(a1*a7+a3*aT+a2*aV+aY*a9+0.5)|0;aO.push(a4,a5)}return this.lines(aO)};this.curveCardinal=function(aR,a4){if(ah===null){return this}var aW,a5,a6,a0,a2,a1,a3,aG,aH,aI,aJ,aY,aZ,aK,aQ=aR.length,aU,aS,aV,aT,aM,aN,aO,aP,aX=[aR[0]|0,aR[1]|0],aL=12;a4=a4||0.5;aW=aR.slice();aW.unshift(aR[1]);aW.unshift(aR[0]);aW.push(aR[aQ-2],aR[aQ-1]);for(aK=2;aK<aQ;aK+=2){aM=aW[aK];aN=aW[aK+1];aO=aW[aK+2];aP=aW[aK+3];a0=(aO-aW[aK-2])*a4;a2=(aW[aK+4]-aM)*a4;a1=(aP-aW[aK-1])*a4;a3=(aW[aK+5]-aN)*a4;for(aZ=0;aZ<=aL;aZ++){aY=aZ/aL;aS=Math.pow(aY,2);aU=aS*aY;aT=aS*3;aV=aU*2;aG=aV-aT+1;aH=aT-aV;aI=aU-2*aS+aY;aJ=aU-aS;a5=(aG*aM+aH*aO+aI*a0+aJ*a2+0.5)|0;a6=(aG*aN+aH*aP+aI*a1+aJ*a3+0.5)|0;aX.push(a5,a6)}}this.lines(aX);return this};this.drawImage=function(aI,aK,aL,aJ,aG,aH){aK=aK|0+aC;aL=aL|0+aD;aJ=(aJ||aI.width)|0;aG=(aG||aI.height)|0;if(X(aH)){ae.putImageData(ak(aI,aJ,aG,o,aH,!0),aK,aL)}else{ae.drawImage(aI,aK,aL,aJ,aG)}aa();if(f){l()}return this};this.drawImageClipped=function(aL,aN,aO,aM,aK,aI,aJ,aH,aG){aN|=0;aO|=0;aM|=0;aK|=0;aI|=0+aC;aJ|=0+aD;aH|=0;aG|=0;if(aN<0){aN=0}if(aO<0){aO=0}if(aN>=aL.width){aN=aL.width-1}if(aO>=aL.height){aO=aL.height-1}if(aN+aM>aL.width){aM=aL.width-aN}if(aO+aK>aL.height){aK=aL.height-aO}ae.drawImage(aL,aN,aO,aM,aK,aI,aJ,aH,aG);aa();if(f){l()}return this};this.xorMode=function(aG){if(!T(aG)){return aF}aF=aG;this.setPixel=aG?e:a;ay=this.setPixel;return this};this.scroll=function(aQ,aR,aG){var aP=(aG&&r!==null),aT,aU,aS,aW=0,aV=am,aH,aI,aJ,aK,aL,aM,aN,aO;if(aQ===0&&aR===0){return this}if(aQ<=-al||aQ>=al||aR<=-am||aR>=am){if(aP){Z.clear()}}else{if(aR!==0){if(aR<0){aW=-aR*al;aV=(am+aQ)*al;aH=aW;aI=aH+1;aJ=aI+1;aK=aJ+1;aL=aK+1;aM=aL+1;aN=aM+1;aO=aN+1;for(;aW<aV;aW+=8){j[aW]=j[aW+aH];j[aW+1]=j[aW+aI];j[aW+2]=j[aW+aJ];j[aW+3]=j[aW+aK];j[aW+4]=j[aW+aL];j[aW+5]=j[aW+aM];j[aW+6]=j[aW+aN];j[aW+7]=j[aW+aO]}if(aP){for(aV=am*al;aW<aV;aW++){j[aW]=r}}aW=0;aV=am+aR}else{aW=(am-aR)*al;aV=0;aH=al*aR;aI=aH-1;aJ=aI-1;aK=aJ-1;aL=aK-1;aM=aL-1;aN=aM-1;aO=aN-1;for(;aW>aV;aW-=8){j[aW+aO]=j[aW-7];j[aW+aN]=j[aW-6];j[aW+aM]=j[aW-5];j[aW+aL]=j[aW-4];j[aW+aK]=j[aW-3];j[aW+aJ]=j[aW-2];j[aW+aI]=j[aW-1];j[aW+aH]=j[aW]}if(aP){for(aW=0;aW<aH;aW++){j[aW]=r}}aW=aR;aV=am}}if(aQ!==0){if(aQ>0){aS=aQ;aH=aQ;for(;aW<aV;aW++){aT=aW*al;for(aU=al;aU>aS;aU--){j[aT+aU]=j[aT+aU-aH]}if(aP){for(;aU>=0;aU--){j[aT+aU]=r}}}}else{aS=al+aQ;aH=-aQ;for(;aW<aV;aW++){aT=aW*al;for(aU=0;aU<aS;aU++){j[aT+aU]=j[aT+aU+aH]}if(aP){for(;aU<al;aU++){j[aT+aU]=r}}}}}}if(f){l()}return this};this.blit=function(aN,aO,aM,aJ,aH,aI){if(aN>=al||aO>=am){return this}if(aN+aM>al){aM=al-aN}if(aO+aJ>am){aJ=am-aJ}var aK=m.getImageData(aN,aO,aM,aJ);if(aF){var aG=new Uint32Array(aK.data.buffer),aL=aG.length;while(aL--){aG[aL]^=(aG[aL]&aE)}}m.putImageData(aK,aH,aI);l(!0);return this};this.setPixel=function(aG,aH){ay(aG,aH);if(f){l()}return this};this.getCanvas=function(){return q};this.getPixel=function(aG,aH){return w(aG,aH)};this.getPixelCol=function(aH,aI){var aG=Q(w(aH,aI));return new retro.Color(aG[0],aG[1],aG[2])};this.getPixelIndex=function(aH,aI){if(o){var aG=Q(w(aH,aI));return o.getNearestIndex(aG[0],aG[1],aG[2])}else{return -1}};this.bucketFill=function(aV,aW){aV|=0;aW|=0;var aQ=2,aR=new Uint16Array(al*am*2),aG=new Uint8Array(al*am),aS=x(aV,aW),aO=al-1,aP=am-1,aT,aU,aH,aI,aL,aM,aJ,aN,aK;aR[0]=aV;aR[1]=aW;aG[aW*al+aV]=1;while(aQ){aQ-=2;aH=aR[aQ];aI=aR[aQ+1];if(x(aH,aI)===aS){az(aH,aI);aT=aU=aH;while(aT>0&&(x(aT-1,aI)===aS)){aL=aI*al+(--aT);if(aG[aL]===1){break}j[aL]=r}while(aU<aO&&(x(aU+1,aI)===aS)){aL=aI*al+(++aU);if(aG[aL]===1){break}j[aL]=r}aM=aN=aI;aM--;aN++;aJ=aM*al;aK=aN*al;for(aH=aT;aH<=aU;aH++){if(aI>0){if(x(aH,aM)===aS){aL=aJ+aH;if(aG[aL]===0){aG[aL]=1;aR[aQ++]=aH;aR[aQ++]=aM}}}if(aI<aP){if(x(aH,aN)===aS){aL=aK+aH;if(aG[aL]===0){aG[aL]=1;aR[aQ++]=aH;aR[aQ++]=aN}}}}}}if(f){l()}return this};this.addFont=function(aG,aL,aK){var aI=0,aJ;if(aG.map.length===0){throw"You need to specify a map for the font."}for(;aI<u.length;aI++){if(u[aI].id===aG.id){throw"A font with this ID already exists"}}function aH(){var aN=document.createElement("canvas"),aO=aN.getContext("2d"),aX=0,aT=0,aU=0,aR,aM,aY=aG.charWidth,aQ=aG.charHeight,aV=aG.map.length,aS=T(aG.invert)?aG.invert:!1,aP={id:aG.id,cw:aY,ch:aQ,length:aV,map:aG.map,canvas:aN,ctx:aO},aW=aS?4294967295:(retro._isLSB?4278190080:255);aN.width=aV*aY;aN.height=aQ;aP.canvas=aN;aP.ctx=aO;for(;aX<aV;aX++){aO.drawImage(aJ,aT,aU,aY,aQ,aX*aY,0,aY,aQ);aT+=aY;if(aT>=aJ.width){aT=0;aU+=aQ}}aR=aO.getImageData(0,0,aN.width,aN.height);aM=new Uint32Array(aR.data.buffer);aX=aM.length;while(aX--){if(aM[aX]!==aW){aM[aX]=0}}aO.putImageData(aR,0,0);u.push(aP);if(U(aL)){aL({id:aP.id,timeStamp:(new Date()).getTime()})}}if(aG.url instanceof Image||aG.url instanceof HTMLCanvasElement){aJ=aG.url;aH()}else{aJ=document.createElement("img");aJ.onload=aH;if(U(aK)){aJ.onerror=aK}if(T(aG.CORS)&&aG.CORS===!0){aJ.crossOrigin=""}aJ.src=aG.url}return this};this.addFonts=function(aI,aM,aL){var aG=aI.length,aJ=0;for(;aJ<aI.length;aJ++){if(U(aL)){Z.addFont(aI[aJ],aK,aH)}else{Z.addFont(aI[aJ],aK)}}function aK(){aG--;if(aG===0){aM()}}function aH(aN){aL(aN);aK()}return this};this.font=function(aH){if(!X(aH)){return n?n.id:""}for(var aG=0;aG<u.length;aG++){if(u[aG].id===aH){n=u[aG];return this}}throw'Font "'+aH+'" not added'};this.text=function(aQ,aT,aU){if(!X(aQ)||aQ.length===0){return this}if(n===null){throw"No font is set!"}var aH="rgb("+Q(ah).join()+")",aO=z(aQ,aT,aU),aJ=0,aS=n.cw,aI=n.ch,aL=n.map,aN=n.ctx,aK=aQ.length,aP=0,aR=al-aS,aM,aG;aT=aO.x;aU=aO.y;if(r){ae.fillStyle=s;ae.fillRect(aT,aU,aK*aS,aI)}if(aj!==ah){aN.globalCompositeOperation="source-in";aN.fillStyle=aH;aN.fillRect(0,0,n.canvas.width,n.canvas.height);aj=ah}for(;aJ<aK&&aP<aR;aJ++){aG=aQ[aJ];aM=aL.indexOf(aG);aP=aT+aJ*aS;if(aM>-1&&aP>=-aS){ae.drawImage(n.canvas,aM*aS,0,aS,aI,aP,aU,aS,aI)}}ac(aU,aU+aI);if(f){l()}return this};this.measureText=function(aG){if(n===null){return{width:0,height:0}}return{width:aG.length*n.cw,height:n.ch}};this.textAlign=function(aG){if(arguments.length===0){return aA}if(aG==="left"||aG==="center"||aG==="middle"||aG==="right"){aA=aG}return this};this.textBaseline=function(aG){if(arguments.length===0){return aB}if(aG==="top"||aG==="center"||aG==="middle"||aG==="bottom"){aB=aG}return this};function z(aI,aK,aL){aK+=aC;aL+=aD;var aH=Z.measureText(aI),aJ=aH.width,aG=aH.height;switch(aA){case"center":case"middle":aK-=(aJ*0.5+0.5)|0;break;case"right":aK-=aJ}switch(aB){case"center":case"middle":aL-=(aG*0.5+0.5)|0;break;case"bottom":aL-=aG}return{x:aK,y:aL}}this.translate=function(aG,aH){if(arguments.length===0){return{deltaX:aC,deltaY:aD}}aC+=(aG|0);aD+=(aH|0);return this};function a(aG,aH){aG+=aC;aH+=aD;if(aG<al&&aH<am&&aG>=0&&aH>=0){j[aH*al+aG]=ah}}function d(aG,aH){aG+=aC;aH+=aD;if(aG<al&&aH<am&&aG>=0&&aH>=0){j[aH*al+aG]=r}}function b(aG,aH){j[aH*al+aG]=ah}function e(aG,aH){if(aG>=0&&aH>=0&&aG<al&&aH<am){j[aH*al+aG]^=(ah&aE)}}function w(aH,aI){aH+=aC;aI+=aD;if(aH<0||aI<0||aH>=al||aI>=am){return[0,0,0,0]}var aG=(aI*al+aH)*4;return[i[aG],i[aG+1],i[aG+2],i[aG+3]]}function x(aG,aH){aG+=aC;aH+=aD;if(aG<0||aH<0||aG>=al||aH>=am){return 0}return j[aH*al+aG]}function l(aG){if(aG===!0){v(al,am,!0)}else{m.putImageData(M,0,0)}p.drawImage(k,0,0,q.width,q.height)}function ao(aI,aH,aG){return 4278190080+(aG<<16)+(aH<<8)+aI}function ap(aI,aH,aG){return(aI<<24)+(aH<<16)+(aG<<8)+255}function R(aI){aI=aI||0;var aJ=(aI&255),aH=(aI&65280)>>8,aG=(aI&16711680)>>16;return[aJ,aH,aG]}function S(aI){aI=aI||0;var aG=(aI&65280)>>8,aH=(aI&16711680)>>16,aJ=(aI&4278190080)>>24;return[aJ,aH,aG]}function aa(){var aQ=ae.getImageData(0,0,al,am),aG=new Uint32Array(aQ.data.buffer),aR=aG.length,aP=0,aH,aI,aJ,aK,aL,aM,aN,aO;for(;aP<aR;aP+=8){aH=aG[aP];aI=aG[aP+1];aJ=aG[aP+2];aK=aG[aP+3];aL=aG[aP+4];aM=aG[aP+5];aN=aG[aP+6];aO=aG[aP+7];if(aH>0){j[aP]=aH}if(aI>0){j[aP+1]=aI}if(aJ>0){j[aP+2]=aJ}if(aK>0){j[aP+3]=aK}if(aL>0){j[aP+4]=aL}if(aM>0){j[aP+5]=aM}if(aN>0){j[aP+6]=aN}if(aO>0){j[aP+7]=aO}}ad.width=al}function ab(aH){var aJ=ae.getImageData(0,0,al,am),aG=new Uint32Array(aJ.data.buffer),aK=aG.length,aI=0;for(;aI<aK;aI+=8){if(aG[aI]>0){j[aI]=aH}if(aG[aI+1]>0){j[aI+1]=aH}if(aG[aI+2]>0){j[aI+2]=aH}if(aG[aI+3]>0){j[aI+3]=aH}if(aG[aI+4]>0){j[aI+4]=aH}if(aG[aI+5]>0){j[aI+5]=aH}if(aG[aI+6]>0){j[aI+6]=aH}if(aG[aI+7]>0){j[aI+7]=aH}}ad.width=al}function ac(aQ,aR){var aP=ae.getImageData(0,0,al,am),aG=new Uint32Array(aP.data.buffer),aH,aI,aJ,aK,aL,aM,aN,aO;aQ*=al;aR*=al;for(;aQ<aR;aQ+=8){aH=aG[aQ];aI=aG[aQ+1];aJ=aG[aQ+2];aK=aG[aQ+3];aL=aG[aQ+4];aM=aG[aQ+5];aN=aG[aQ+6];aO=aG[aQ+7];if(aH>0){j[aQ]=aH}if(aI>0){j[aQ+1]=aI}if(aJ>0){j[aQ+2]=aJ}if(aK>0){j[aQ+3]=aK}if(aL>0){j[aQ+4]=aL}if(aM>0){j[aQ+5]=aM}if(aN>0){j[aQ+6]=aN}if(aO>0){j[aQ+7]=aO}}ad.width=al}this.onclick=this.ondblclick=this.onmousedown=this.onmousemove=this.onmouseover=this.onmouseout=this.onmouseenter=this.onmouseleave=this.onmouseup=this.onkeydown=this.onkeypress=this.onkeyup=undefined;q.addEventListener("click",A,!1);q.addEventListener("dblclick",B,!1);q.addEventListener("mousedown",F,!1);q.addEventListener("mouseover",K,!1);q.addEventListener("mouseout",J,!1);q.addEventListener("mouseenter",G,!1);q.addEventListener("mouseleave",H,!1);window.addEventListener("mousemove",I,!1);window.addEventListener("mouseup",L,!1);window.addEventListener("keydown",C,!1);window.addEventListener("keypress",D,!1);window.addEventListener("keyup",E,!1);function A(aG){if(U(Z.onclick)){ax(aG,Z.onclick)}}function B(aG){if(U(Z.ondblclick)){ax(aG,Z.ondblclick)}}function F(aG){if(U(Z.onmousedown)){ax(aG,Z.onmousedown)}}function I(aG){if(U(Z.onmousemove)){ax(aG,Z.onmousemove)}}function K(aG){if(U(Z.onmouseover)){ax(aG,Z.onmouseover)}}function G(aG){if(U(Z.onmouseenter)){ax(aG,Z.onmouseenter)}}function H(aG){if(U(Z.onmouseleave)){ax(aG,Z.onmouseleave)}}function J(aG){if(U(Z.onmouseout)){ax(aG,Z.onmouseout)}}function L(aG){if(U(Z.onmouseup)){ax(aG,Z.onmouseup)}}function C(aG){if(U(Z.onkeydown)){aw(aG,Z.onkeydown)}}function D(aG){if(U(Z.onkeypress)){aw(aG,Z.onkeypress)}}function E(aG){if(U(Z.onkeyup)){aw(aG,Z.onkeyup)}}function y(aG){var aH=q.getBoundingClientRect();return{x:((aG.clientX-aH.left)*au)|0,y:((aG.clientY-aH.top)*av)|0}}function ax(aG,aH){aG=aG||event;var aI=y(aG);aH({button:aG.button,buttons:aG.buttons,altKey:aG.altKey,ctrlKey:aG.ctrlKey,metaKey:aG.metaKey,shiftKey:aG.shiftKey,x:aI.x,y:aI.y,event:aG,timeStamp:aG.timeStamp,preventDefault:aG.preventDefault,stopPropagation:aG.stopPropagation,source:Z})}function aw(aG,aH){aG=aG||event;var aI=y(aG);aH({altKey:aG.altKey,ctrlKey:aG.ctrlKey,metaKey:aG.metaKey,shiftKey:aG.shiftKey,charCode:aG.charCode,key:aG.keyCode||aG.which,x:aI.x,y:aI.y,event:aG,timeStamp:aG.timeStamp,preventDefault:aG.preventDefault,stopPropagation:aG.stopPropagation,source:Z})}function P(){if(retro._isLSB===!0){an=ao;Q=R;ag=4278190080;aE=16777215;ah=4294967295;r=4278190080}else{an=ap;Q=S;ag=255;aE=4278190080;ah=4294967295;r=255}}function O(){p=q.getContext("2d",{alpha:!1});p.setTransform(1,0,0,1,0,0);ae.setTransform(1,0,0,1,0,0);m.setTransform(1,0,0,1,0,0);af(p);af(ae);af(m);p.globalCompositeOperation="copy"}function v(aH,aI,aG){M=(aG)?m.getImageData(0,0,aH,aI):m.createImageData(aH,aI);i=M.data;j=new Uint32Array(i.buffer)}function ak(a2,bf,aZ,bd,a8,be){be=be||!1;var aR=N(a2,bf,aZ),a1,aH,aI,a4,aJ=[],aX,a7,a0=0,a3,bg,bh,bb,bj,bi,ba,a9,aW,aS,aG=a8.split("-"),bc=aG[0],aU=aG[1]||"";a1=aR.getImageData(0,0,bf,aZ);aH=a1.data;a4=aH.length;if(aG.length===2){for(bh=0;bh<aZ;bh++){aJ.push([]);bj=bh*bf*4;for(bg=0,bi=aJ[bh];bg<bf;bg++){bb=bj+bg*4;bi.push(new retro.Color(aH[bb],aH[bb+1],aH[bb+2]))}}switch(bc){case"palette":aX=aY;break;case"16bit":aX=retro._isLSB?aM:aN;break;case"12bit":aX=retro._isLSB?aK:aL;break;case"8bit":aX=retro._isLSB?aO:aP;break;case"1bit":case"mono":aX=aQ;break}aS=(aU==="fs")?aT:aV;for(bh=0,bb=0;bh<aZ;bh++){for(bg=0;bg<bf;bg++){ba=aJ[bh][bg];a9=aX(ba);aW=ba.sub(a9);aH[bb++]=a9.r;aH[bb++]=a9.g;aH[bb++]=a9.b;bb++;aS(aJ,bg,bh,bf,aZ,aW)}}aJ=null}else{if(a8==="palette"){for(var a6=bd.lut;a0<a4;a0+=4){a3=bd.getNearestIndex(aH[a0],aH[a0+1],aH[a0+2]);a3=a6[a3];aH[a0]=a3[0];aH[a0+1]=a3[1];aH[a0+2]=a3[2]}}else{if(a8==="1bit"||a8==="mono"){var a5;for(;a0<a4;a0+=4){a5=aH[a0]*0.299+aH[a0+1]*0.587+aH[a0+2]*0.114;a5=a5>=128?255:0;aH[a0]=a5;aH[a0+1]=a5;aH[a0+2]=a5}}else{if(a8==="8bit"){if(retro._isLSB){for(;a0<a4;a0+=4){aH[a0]=aH[a0]&224+(aH[a0]>>3)|0;aH[a0+1]=aH[a0+1]&224+(aH[a0+2]>>3)|0;aH[a0+2]=aH[a0+2]&192+(aH[a0+3]>>3)|0}}else{for(;a0<a4;a0+=4){aH[a0]=aH[a0]&14+(aH[a0]>>3)|0;aH[a0+1]=aH[a0+1]&14+(aH[a0+2]>>3)|0;aH[a0+2]=aH[a0+2]&12+(aH[a0+3]>>3)|0}}}else{aI=new Uint32Array(aH.buffer);a4=aI.length;switch(a8){case"16bit":a7=retro._isLSB?4294507768:2412744703;break;case"12bit":a7=retro._isLSB?4293980400:252645375;break;case"8bit":a7=retro._isLSB?4292927680:202247935;break}for(;a0<a4;a0++){aI[a0]&=a7}}}}}function aM(bk){return new retro.Color(bk.r&248,bk.g&252,bk.b&248)}function aN(bk){return new retro.Color(bk.r&143,bk.g&207,bk.b&143)}function aK(bk){return new retro.Color(bk.r&240,bk.g&240,bk.b&240)}function aL(bk){return new retro.Color(bk.r&15,bk.g&15,bk.b&15)}function aO(bk){return new retro.Color(bk.r&224+(bk.r>>3),bk.g&192+(bk.g>>3),bk.b&224+(bk.b>>3))}function aP(bk){return new retro.Color(bk.r&14+(bk.r<<3),bk.g&12+(bk.g<<3),bk.b&14+(bk.b<<3))}function aQ(bk){return bk.threshold(150)}function aY(bk){return bd.getNearestColor(bk.r,bk.g,bk.b)}function aT(bk,bp,bs,bo,bn,bm){var br=bp+1,bt=bs+1,bq,bl;if(br<bo){bk[bs][br]=bk[bs][br].add(bm.mul(0.4375))}if(bt<bn){bq=bp-1;bl=bk[bt];bl[bp]=bl[bp].add(bm.mul(0.3125));if(bq>=0){bl[bq]=bl[bq].add(bm.mul(0.1875))}if(br<bo){bl[br]=bl[br].add(bm.mul(0.0625))}}}function aV(bk,bp,bs,bo,bn,bm){var br=bp+1,bq=bp-1,bt=bs+1,bl=bk[bt];if(br<bo){bk[bs][br]=bk[bs][br].add(bm.mul(0.5))}if(bt<bn){bl[bp]=bl[bp].add(bm.mul(0.25));if(bq>=0){bl[bq]=bl[bq].add(bm.mul(0.25))}}}if(be){return a1}else{aR.putImageData(a1,0,0);return c}}function af(aG){if(T(aG.imageSmoothingEnabled)){aG.imageSmoothingEnabled=!1}else{if(T(aG.webkitImageSmoothingEnabled)){aG.webkitImageSmoothingEnabled=!1}else{if(T(aG.mozImageSmoothingEnabled)){aG.mozImageSmoothingEnabled=!1}else{if(T(aG.msImageSmoothingEnabled)){aG.msImageSmoothingEnabled=!1}else{if(T(aG.oImageSmoothingEnabled)){aG.oImageSmoothingEnabled=!1}}}}}}function N(aJ,aK,aI){var aG=document.createElement("canvas"),aH=aG.getContext("2d");aG.width=aK;aG.height=aI;af(aH);aH.drawImage(aJ,0,0,aK,aI);return aH}function X(aG){return typeof aG==="string"}function V(aG){return typeof aG==="number"}function T(aG){return typeof aG==="boolean"}function W(aG){return typeof aG==="object"}function U(aG){return typeof aG==="function"||W(aG)}this.clear();return this};retro._isLSB=((new Uint16Array(new Uint8Array([255,0]).buffer))[0]===255);(function(){var a=0,c=["webkit","moz","ms","o"],b,d=0;for(;b=c[d]&&!window.requestAnimationFrame;d++){window.requestAnimationFrame=window[b+"RequestAnimationFrame"];window.cancelAnimationFrame=window[b+"CancelAnimationFrame"]||window[b+"CancelRequestAnimationFrame"]}if(!window.requestAnimationFrame){window.requestAnimationFrame=function(e){var f=new Date().getTime();var h=Math.max(0,16-(f-a));var g=window.setTimeout(function(){e(f+h)},h);a=f+h;return g}}if(!window.cancelAnimationFrame){window.cancelAnimationFrame=function(e){clearTimeout(e)}}}());window.HTMLCanvasElement.prototype.z___RETRO___gc_vector=window.HTMLCanvasElement.prototype.getContext;window.HTMLCanvasElement.prototype.getContext=function(a){if(a.toLowerCase()==="retro"){return new retro.Context(this)}return this.z___RETRO___gc_vector(a)};retro.Palette=function(f,d){var c,b,a;this.name=d||"custom";this.lut=null;this._lutCache=[];if(typeof f==="string"){f=f.toUpperCase();if(retro.Palette[f]){this.lut=retro.Palette[f];this.name=f}else{throw"Unknown palette name "+f}}else{if(Array.isArray(f)){if(f[0] instanceof retro.Color){c=[];for(b=0;a=f[b++];){if(a instanceof retro.Color){c.push([a.r,a.g,a.b])}}this.lut=c}else{for(b=0;a=f[b++];){if(a.length!==3){throw"Invalid palette array. Expected sub-array of 3 entries (RGB) at index "+b}}this.lut=f}}}for(b=0;a=this.lut[b++];){this._lutCache.push((new retro.Color(a[0],a[1],a[2])).toInt())}this.length=this.lut.length;return this};retro.Palette.prototype.getColor=function(b){if(b<0){b=0}if(b>=this.lut.length){b=this.lut.length-1}var a=this.lut[b];return new retro.Color(a[0],a[1],a[2])};retro.Palette.prototype.getIndex=function(n,h,a,q){q=((q||0)*2.55+0.5)|0;var m=this.lut,f,l=0,p,o,k,j,e,d;if(q===0){for(;f=m[l];l++){if(n===f[0]&&h===f[1]&&a===f[2]){return l}}}else{p=n-q;o=n+q;k=h-q;j=h+q;e=a-q;d=a+q;p=Math.max(0,Math.min(255,p));o=Math.max(0,Math.min(255,o));k=Math.max(0,Math.min(255,k));j=Math.max(0,Math.min(255,j));e=Math.max(0,Math.min(255,e));d=Math.max(0,Math.min(255,d));for(;f=m[l];l++){n=f[0];h=f[1];a=f[2];if(n>=p&&n<=o&&h>=k&&h<=j&&a>=e&&a<=d){return l}}}return -1};retro.Palette.prototype.getNearestIndex=function(t,m,a){var n=0,e,f,k,j,h,s=195100,q=-1,p=this.lut,o=p.length;for(;n<o;n++){e=p[n];k=e[0]-t;j=e[1]-m;h=e[2]-a;f=k*k+j*j+h*h;if(f<s){s=f;q=n}}return q};retro.Palette.prototype.getNearestColor=function(e,c,a){var d=this.lut[this.getNearestIndex(e,c,a)];return new retro.Color(d[0],d[1],d[2])};retro.Palette.AMIGA=[[0,0,0],[0,0,0],[255,255,255],[86,119,170],[0,0,255],[255,0,255],[0,255,255],[255,255,255],[100,34,0],[236,84,0],[150,255,16],[240,190,0],[120,120,120],[170,170,170],[170,150,120],[236,170,150]];retro.Palette.BW=[[0,0,0],[255,255,255]];retro.Palette.GREEN=[[0,0,0],[0,255,0]];retro.Palette.C64=[[0,0,0],[255,255,255],[250,51,0],[29,224,255],[169,73,210],[104,186,81],[79,68,216],[255,238,68],[255,91,0],[193,63,0],[255,114,62],[96,96,96],[140,140,140],[179,255,151],[163,151,255],[200,183,230]];retro.Palette.C64G=[[0,0,0],[255,255,255],[104,55,43],[112,164,178],[111,61,134],[88,141,67],[53,40,121],[184,199,111],[111,79,37],[67,57,0],[154,103,89],[68,68,68],[108,108,108],[154,210,132],[108,94,181],[149,149,149]];retro.Palette.VIC20=[[0,0,0],[255,255,255],[120,41,34],[135,214,221],[170,95,182],[85,160,73],[64,49,141],[191,206,114],[170,116,73],[234,180,137],[184,105,98],[199,255,255],[234,159,246],[148,224,137],[128,113,204],[255,255,178]];retro.Palette.AMSTRADCPC=[[0,0,0],[0,0,128],[0,0,255],[128,0,0],[128,0,128],[128,0,255],[255,0,0],[255,0,128],[255,0,255],[0,128,0],[0,128,128],[0,128,255],[128,128,0],[128,128,128],[128,128,255],[255,128,0],[255,128,128],[255,128,255],[0,255,0],[0,255,128],[0,255,255],[128,255,0],[128,255,128],[128,255,255],[255,255,0],[255,255,128],[255,255,255]];retro.Palette.APPLEII=[[0,0,0],[108,41,64],[64,53,120],[217,60,240],[19,87,64],[128,128,128],[38,151,240],[191,180,248],[64,75,7],[217,104,15],[128,128,128],[236,168,191],[38,195,15],[191,202,135],[147,214,191],[255,255,255]];retro.Palette.ZXSPECTRUM=[[0,0,0],[0,0,192],[192,0,0],[192,0,192],[0,192,0],[0,192,192],[192,192,0],[192,192,192],[0,0,0],[0,0,255],[255,0,0],[255,0,255],[0,255,0],[0,255,255],[255,255,0],[255,255,255]];retro.Palette.BBC=[[0,0,0,],[255,0,0],[0,255,0],[0,0,255],[0,255,255],[255,0,255],[255,255,0],[255,255,255]];retro.Palette.CGA=[[0,0,0],[0,0,170],[0,170,0],[0,170,170],[170,0,0],[170,0,170],[170,85,0],[170,170,170],[85,85,85],[85,85,255],[85,255,85],[85,255,255],[255,85,85],[255,85,255],[255,255,85],[255,255,255]];retro.Palette.MSX=[[0,0,0],[62,184,73],[116,208,125],[89,85,224],[128,118,241],[185,94,81],[101,219,239],[219,101,89],[255,137,125],[204,195,94],[222,208,135],[58,162,65],[183,102,181],[204,204,204],[255,255,255]];retro.Palette.TELETEXT=[[0,0,0],[0,0,255],[255,0,0],[255,0,255],[0,255,0],[0,255,255],[255,255,0],[255,255,255]];retro.Palette.THOMSONMO5=[[0,0,0],[255,0,0],[0,255,0],[255,255,0],[0,0,255],[255,0,255],[0,255,255],[255,255,255],[187,187,187],[221,119,119],[119,221,119],[221,221,119],[119,119,221],[221,119,238],[187,255,255],[238,187,0]];retro.Palette.NES=[[124,124,124],[0,0,252],[0,0,188],[68,40,188],[148,0,132],[168,0,32],[168,16,0],[136,20,0],[80,48,0],[0,120,0],[0,104,0],[0,88,0],[0,64,88],[0,0,0],[0,0,0],[0,0,0],[188,188,188],[0,120,248],[0,88,248],[104,68,252],[216,0,204],[228,0,88],[248,56,0],[228,92,16],[172,124,0],[0,184,0],[0,168,0],[0,168,68],[0,136,136],[0,0,0],[0,0,0],[0,0,0],[248,248,248],[60,188,252],[104,136,252],[152,120,248],[248,120,248],[248,88,152],[248,120,88],[252,160,68],[248,184,0],[184,248,24],[88,216,84],[88,248,152],[0,232,216],[120,120,120],[0,0,0],[0,0,0],[252,252,252],[164,228,252],[184,184,248],[216,184,248],[248,184,248],[248,164,192],[240,208,176],[252,224,168],[248,216,120],[216,248,120],[184,248,184],[184,248,216],[0,252,252],[216,216,216],[0,0,0],[0,0,0]];retro.Palette.INTELLIVISION=[[0,0,0],[165,150,255],[255,61,17],[181,25,88],[84,110,0],[0,167,87],[255,180,32],[201,207,171],[0,46,255],[36,184,255],[255,78,88],[188,72,199],[56,107,64],[117,203,128],[250,234,79],[255,255,255]];retro.Palette.GAMEBOY=[[0,67,29],[0,109,61],[106,187,35],[121,204,36]];retro.Palette.EGA=[[0,0,0],[73,0,174],[0,190,36],[0,179,176],[192,0,0],[202,0,173],[156,182,2],[169,170,174],[37,0,94],[110,0,255],[0,188,98],[0,161,255],[194,0,90],[215,0,254],[159,179,94],[185,150,255],[0,98,18],[42,69,175],[0,255,53],[0,255,178],[184,75,0],[195,0,173],[68,255,43],[96,255,177],[0,92,95],[95,0,255],[0,255,103],[0,255,255],[187,67,91],[209,0,254],[75,255,100],[125,255,255],[98,0,0],[118,0,174],[0,188,33],[0,177,176],[255,0,0],[255,0,170],[255,167,0],[255,154,172],[103,0,93],[142,0,255],[0,186,97],[83,159,255],[255,0,83],[255,0,253],[255,164,88],[255,132,254],[80,94,0],[105,61,174],[0,255,51],[0,255,178],[255,0,0],[255,0,171],[236,255,4],[244,255,174],[86,87,94],[132,0,255],[0,255,102],[0,255,255],[255,0,84],[255,0,253],[238,255,94],[255,255,255]];retro.Palette.SEGA=[[0,0,0],[37,0,94],[72,0,174],[109,0,254],[97,0,0],[102,0,92],[119,0,174],[142,0,254],[191,0,0],[194,0,90],[201,0,171],[215,0,254],[255,0,0],[255,0,84],[255,0,170],[255,0,252],[0,98,19],[0,92,94],[43,66,174],[94,0,254],[80,92,9],[86,87,93],[104,60,175],[130,0,254],[184,76,0],[187,65,90],[194,0,173],[209,0,254],[255,0,0],[255,0,84],[255,0,171],[255,0,251],[0,190,36],[0,189,97],[0,179,176],[0,161,255],[0,188,32],[0,186,96],[0,177,175],[83,157,255],[157,181,5],[160,177,94],[168,169,174],[185,150,255],[255,167,0],[255,165,87],[255,152,171],[255,131,253],[0,255,53],[0,255,103],[0,255,179],[0,255,255],[0,255,51],[0,255,103],[0,255,178],[0,255,255],[67,255,43],[71,255,98],[96,255,176],[127,255,255],[236,255,14],[238,255,94],[244,255,175],[255,254,255]];retro.Palette.AQUARIUS=[[24,25,29],[55,56,62],[191,0,33],[255,0,0],[0,222,85],[0,255,58],[240,255,126],[245,252,21],[95,0,142],[100,0,223],[241,0,205],[255,0,253],[0,179,176],[0,215,208],[203,204,207],[255,255,255]];retro.Palette.ATARI2600NTSC=[[0,0,0],[67,68,74],[108,109,116],[143,144,150],[175,176,180],[199,200,203],[219,220,222],[236,236,237],[65,76,0],[93,109,29],[123,141,48],[148,170,63],[171,195,74],[194,220,89],[217,246,101],[236,255,112],[124,26,0],[143,63,23],[162,89,46],[180,119,67],[195,140,83],[210,161,98],[224,183,110],[232,209,130],[148,0,0],[169,14,21],[188,64,52],[209,91,77],[224,118,97],[239,140,116],[250,162,132],[255,183,151],[154,0,0],[175,0,33],[196,0,64],[212,62,93],[228,92,116],[244,119,139],[255,146,163],[255,167,182],[140,0,99],[162,0,121],[183,0,140],[199,40,160],[215,78,179],[231,103,194],[241,133,209],[255,156,224],[96,0,127],[121,0,149],[144,0,168],[164,38,187],[183,76,206],[203,100,221],[217,130,236],[232,153,252],[63,0,138],[82,0,157],[104,0,176],[128,47,195],[145,83,210],[166,112,225],[183,142,237],[202,163,252],[58,0,142],[71,0,161],[88,0,180],[104,62,195],[122,94,211],[138,122,226],[153,151,237],[171,172,252],[50,0,131],[59,23,150],[77,65,173],[93,98,192],[111,125,207],[128,146,222],[144,173,237],[162,194,253],[22,39,101],[31,74,127],[52,102,150],[71,130,177],[92,155,196],[108,180,215],[125,205,234],[145,225,253],[0,74,56],[0,101,83],[0,134,109],[0,166,136],[32,191,155],[51,221,178],[81,241,197],[100,255,216],[0,72,8],[0,104,46],[0,136,76],[0,169,102],[59,194,125],[84,223,148],[117,243,170],[134,255,190],[0,67,6],[0,103,42],[39,136,68],[72,164,91],[93,193,114],[118,218,133],[142,243,151],[160,255,170],[43,57,0],[71,88,40],[94,120,63],[121,148,86],[142,177,109],[165,202,128],[190,222,142],[208,247,162],[75,44,0],[105,76,34],[135,107,57],[161,136,76],[185,160,95],[208,184,114],[232,209,130],[252,230,145]];retro.Palette.ATARI2600PAL=[[0,0,0],[67,68,74],[108,109,116],[143,144,150],[175,176,180],[199,200,203],[219,220,222],[236,236,237],[133,90,0],[152,115,40],[171,135,68],[190,159,95],[206,175,118],[221,195,137],[238,211,160],[255,226,179],[48,103,10],[68,131,46],[92,156,72],[113,184,98],[133,204,121],[147,225,140],[161,246,162],[182,255,181],[123,48,0],[146,77,39],[170,101,67],[188,130,95],[208,150,118],[229,170,137],[244,190,160],[255,211,179],[0,114,37],[0,143,66],[0,167,92],[0,191,118],[0,211,141],[51,231,163],[99,246,186],[123,255,205],[127,0,23],[153,0,58],[179,0,86],[199,62,113],[220,90,136],[242,110,159],[255,136,182],[255,158,201],[0,99,101],[0,123,124],[0,147,147],[30,171,170],[71,191,189],[97,206,204],[125,226,223],[149,242,238],[131,0,99],[154,0,122],[170,0,141],[190,46,160],[201,82,179],[217,106,194],[227,136,209],[242,158,225],[20,55,120],[27,85,143],[46,114,165],[67,139,185],[88,163,204],[108,183,223],[126,204,238],[145,225,253],[110,0,119],[131,0,141],[152,0,164],[172,38,183],[187,77,202],[203,100,221],[217,130,236],[232,153,252],[42,0,119],[54,42,142],[71,75,165],[87,107,184],[110,126,203],[126,152,222],[144,173,237],[162,194,253],[87,0,134],[110,0,153],[133,0,172],[152,41,191],[170,79,206],[190,103,221],[203,133,237],[218,155,252],[58,0,142],[73,0,161],[92,0,180],[113,52,195],[132,86,210],[150,109,226],[171,138,237],[189,159,252]];retro.Palette.C16=[[0,0,0],[37,38,43],[106,0,0],[0,60,80],[113,0,115],[0,91,18],[59,0,117],[22,57,9],[105,0,0],[69,34,0],[0,73,14],[108,0,40],[0,73,45],[31,36,117],[85,0,117],[0,82,16],[0,0,0],[66,67,73],[140,0,29],[0,91,111],[151,0,146],[0,123,24],[87,0,147],[53,87,11],[137,36,0],[99,66,0],[0,107,19],[142,0,71],[0,105,75],[23,72,148],[119,0,147],[0,115,41],[0,0,0],[96,97,104],[170,56,61],[0,123,142],[184,0,175],[0,158,41],[117,48,176],[81,121,34],[169,72,16],[130,98,27],[0,140,37],[174,25,101],[0,138,105],[31,106,176],[151,0,174],[0,148,70],[0,0,0],[127,128,134],[203,90,93],[0,155,172],[219,0,205],[0,191,67],[148,86,206],[111,153,63],[200,104,55],[161,130,60],[0,174,66],[208,69,132],[0,169,135],[57,138,207],[184,32,204],[0,181,100],[0,0,0],[157,158,163],[236,122,124],[52,187,203],[255,0,236],[0,225,96],[178,118,237],[141,185,92],[233,136,87],[192,162,91],[68,207,95],[244,102,161],[0,202,165],[85,170,236],[218,81,235],[0,215,130],[0,0,0],[189,190,194],[255,155,154],[85,220,232],[255,80,253],[0,255,126],[207,157,254],[172,217,122],[255,167,118],[224,195,119],[106,240,123],[255,135,192],[53,234,196],[109,204,255],[249,125,254],[0,248,160],[0,0,0],[222,222,224],[255,193,187],[119,254,255],[255,141,253],[66,255,154],[235,196,254],[204,250,151],[255,207,148],[255,226,149],[140,255,153],[255,175,223],[99,255,226],[128,244,255],[255,169,253],[79,255,191],[0,0,0],[255,254,255],[255,230,219],[168,255,255],[255,213,254],[148,255,183],[255,235,254],[199,255,183],[252,244,182],[245,255,182],[199,255,183],[255,213,254],[168,255,255],[168,255,255],[255,213,254],[157,255,219]];retro.Palette.CBMP4=[[0,0,0],[37,38,44],[67,68,74],[97,98,104],[127,129,135],[158,159,164],[190,191,194],[222,223,225],[255,255,255],[106,0,0],[139,0,29],[171,56,63],[205,90,94],[238,123,125],[255,155,156],[255,193,187],[255,231,218],[0,60,80],[0,92,111],[0,124,141],[0,156,172],[49,188,202],[87,220,233],[120,254,255],[167,255,255],[114,0,116],[150,0,146],[184,0,175],[220,0,205],[255,0,235],[255,81,253],[255,144,254],[255,213,254],[0,91,14],[0,125,25],[0,159,41],[0,192,68],[0,225,97],[0,255,126],[62,255,155],[149,255,184],[59,0,116],[88,0,147],[117,49,176],[148,86,206],[179,119,237],[208,156,255],[234,196,255],[255,235,255],[24,57,2],[53,89,6],[81,121,33],[112,153,63],[141,185,93],[172,218,122],[204,251,152],[200,255,183],[106,0,0],[138,34,0],[169,72,6],[202,104,55],[234,137,87],[255,169,118],[255,207,150],[253,245,181],[70,35,0],[99,67,0],[129,99,27],[160,131,59],[191,163,90],[223,195,120],[255,228,150],[245,255,182],[0,74,10],[0,107,18],[0,140,37],[0,173,65],[70,206,95],[108,240,124],[142,255,154],[200,255,183],[107,0,40],[142,0,71],[175,26,102],[209,69,132],[243,102,162],[255,136,192],[255,175,223],[255,213,254],[0,74,45],[0,106,75],[0,138,106],[0,169,136],[0,202,166],[49,235,196],[97,255,226],[167,255,255],[31,37,117],[21,73,147],[30,106,177],[56,139,207],[86,170,238],[109,205,255],[129,244,255],[167,255,255],[85,0,116],[118,0,146],[151,0,176],[185,36,206],[218,83,236],[249,125,254],[255,169,254],[255,215,254],[0,82,12],[0,116,41],[0,149,71],[0,182,101],[0,215,131],[0,248,161],[79,255,191],[157,255,220]];retro.Palette.MSX2=[[0,0,0],[37,0,94],[72,0,174],[109,0,254],[46,0,0],[57,0,93],[83,0,174],[116,0,253],[86,0,0],[91,0,93],[108,0,174],[134,0,254],[124,0,0],[127,0,92],[140,0,174],[160,0,254],[164,0,0],[167,0,90],[176,0,174],[192,0,254],[205,0,0],[207,0,89],[214,0,172],[227,0,253],[248,0,0],[249,0,87],[255,0,171],[255,0,253],[255,0,0],[255,0,84],[255,0,170],[255,0,252],[0,47,9],[25,29,94],[67,0,174],[107,0,255],[38,45,0],[51,25,94],[80,0,174],[114,0,254],[80,38,0],[88,0,95],[105,0,174],[132,0,254],[121,18,0],[126,0,92],[137,0,173],[159,0,254],[163,0,0],[166,0,92],[175,0,174],[190,0,254],[205,0,0],[206,0,89],[213,0,173],[226,0,253],[246,0,0],[249,0,87],[255,0,171],[255,0,253],[255,0,0],[255,0,84],[255,0,170],[255,0,252],[0,85,17],[0,78,96],[53,43,174],[98,0,255],[0,84,16],[26,76,95],[68,43,174],[107,0,255],[69,81,9],[77,75,94],[97,34,175],[126,0,254],[115,75,0],[118,67,92],[132,6,174],[153,0,254],[159,65,0],[161,54,91],[171,0,175],[187,0,254],[201,46,0],[203,31,90],[211,0,174],[223,0,254],[243,0,0],[245,0,88],[251,0,172],[255,0,253],[255,0,0],[255,0,85],[255,0,170],[255,0,251],[0,123,24],[0,119,95],[0,102,174],[81,58,254],[0,123,23],[0,118,95],[38,101,174],[92,56,255],[38,121,20],[53,116,94],[80,100,175],[114,51,255],[102,117,9],[105,113,93],[121,95,175],[144,40,254],[149,113,0],[152,106,92],[163,89,173],[180,0,254],[192,105,0],[197,97,90],[204,78,173],[218,0,254],[239,92,0],[240,87,87],[246,60,172],[255,0,253],[255,76,0],[255,68,83],[255,10,171],[255,0,251],[0,163,32],[0,162,96],[0,150,176],[40,127,255],[0,163,31],[0,160,96],[0,149,176],[58,128,255],[0,163,28],[0,158,95],[39,148,176],[93,124,255],[71,160,23],[82,156,95],[101,145,174],[129,119,255],[134,156,5],[138,153,94],[149,141,174],[167,114,255],[183,151,0],[185,148,91],[192,136,173],[207,109,253],[229,144,0],[233,140,89],[239,127,173],[249,98,253],[255,134,0],[255,131,86],[255,115,171],[255,82,253],[0,203,39],[0,201,100],[0,193,176],[0,177,255],[0,203,38],[0,202,98],[0,193,177],[0,176,255],[0,202,36],[0,200,98],[0,190,176],[45,175,255],[0,201,33],[0,197,96],[63,190,176],[103,173,255],[112,197,26],[114,195,96],[128,187,175],[150,170,255],[167,194,7],[170,191,94],[179,183,174],[194,165,255],[217,189,0],[222,185,92],[228,177,174],[240,159,254],[255,182,0],[255,180,88],[255,170,173],[255,151,253],[0,245,46],[0,242,101],[0,237,178],[0,224,255],[0,244,45],[0,243,100],[0,236,178],[0,223,255],[0,244,44],[0,242,100],[0,235,178],[0,223,255],[0,242,41],[0,240,100],[0,234,178],[41,222,255],[56,240,37],[74,237,98],[94,232,177],[123,218,255],[143,237,29],[148,235,98],[157,228,175],[176,216,255],[202,233,12],[204,231,93],[211,224,174],[224,212,255],[253,228,0],[254,226,92],[255,220,174],[255,206,254],[0,255,53],[0,255,103],[0,255,179],[0,255,255],[0,255,53],[0,255,102],[0,255,179],[0,255,255],[0,255,51],[0,255,102],[0,255,178],[0,255,255],[0,255,49],[0,255,102],[0,255,177],[0,255,255],[0,255,46],[0,255,99],[0,255,177],[71,255,255],[105,255,41],[112,255,98],[125,255,176],[148,255,255],[180,255,32],[181,255,96],[191,255,176],[204,255,255],[236,255,14],[238,255,94],[244,255,175],[255,254,255]];retro.Point=function(a,b){this.x=(a+0.5)|0;this.y=(b+0.5)|0};retro.Point.prototype.translate=function(a,b){this.x=(this.x+a+0.5)|0;this.y=(this.y+b+0.5)|0;return this};retro.Point.prototype.scale=function(a,b){this.x=(this.x*a+0.5)|0;this.y=(this.y*b+0.5)|0;return this};retro.Point.prototype.add=function(a){this.x+=a.x;this.y+=a.y;return this};retro.Point.prototype.mul=function(a){this.x*=a.x;this.y*=a.y;return this};retro.Point.prototype.div=function(a){if(a.x!==0){this.x/=a.x}if(a.y!==0){this.y/=a.y}return this};retro.Color=function(d,c,a){this.r=Math.min(Math.max(0,(d+0.5)|0),255);this.g=Math.min(Math.max(0,(c+0.5)|0),255);this.b=Math.min(Math.max(0,(a+0.5)|0),255);this.int32=0;this.update()};retro.Color.prototype.add=function(a){return new retro.Color(this.r+a.r,this.g+a.g,this.b+a.b)};retro.Color.prototype.sub=function(a){return new retro.Color(this.r-a.r,this.g-a.g,this.b-a.b)};retro.Color.prototype.mul=function(a){return new retro.Color(this.r*a,this.g*a,this.b*a)};retro.Color.prototype.rshift=function(a){return new retro.Color(this.r>>a,this.g>>a,this.b>>a)};retro.Color.prototype.lshift=function(a){return new retro.Color(this.r<<a,this.g<<a,this.b<<a)};retro.Color.prototype.diff=function(a){return(this.r*this.r+this.g*this.g+this.b*this.b)-(a.r*a.r+a.g*a.g*a.b*a.b)};retro.Color.prototype.diffSqrt=function(a){return Math.sqrt(this.r*this.r+this.g*this.g+this.b*this.b)-Math.sqrt(a.r*a.r+a.g*a.g*a.b*a.b)};retro.Color.prototype.threshold=function(b){var a=this.r*0.299+this.g*0.587+this.b*0.114;return a>=b?new retro.Color(255,255,255):new retro.Color(0,0,0)};retro.Color.prototype.invert=function(){return new retro.Color(255-this.r,255-this.g,255-this.b)};retro.Color.prototype.setRGB=function(d,c,a){this.r=d;this.g=c;this.b=a;this.update();return this};retro.Color.prototype.setInteger=function(b){var a=this.int2rgb(b);this.int32=b;this.r=a[0];this.g=a[1];this.b=a[2];return this};retro.Color.prototype.rgb2int=retro._isLSB?function(d,c,a){return 4278190080+(a<<16)+(c<<8)+d}:function(d,c,a){return(d<<24)+(c<<16)+(a<<8)+255};retro.Color.prototype.int2rgb=retro._isLSB?function(d){var e=(d&255),c=(d&65280)>>8,a=(d&16711680)>>16;return[e,c,a]}:function(d){var a=(d&65280)>>8,c=(d&16711680)>>16,e=(d&4278190080)>>24;return[e,c,a]};retro.Color.prototype.toArray=function(){return[this.r,this.g,this.b]};retro.Color.prototype.toInt=function(){return this.int32};retro.Color.prototype.toObject=function(){return{r:this.r,g:this.g,b:this.b}};retro.Color.prototype.toString=function(){return this.r+","+this.g+","+this.b};retro.Color.prototype.toStyle=function(){return"rgb("+this.r+","+this.g+","+this.b+")"};retro.Color.prototype.getToleranceRange=function(d){var a,b,c=0;a=[this.r,this.g,this.b];b=[this.r,this.g,this.b];for(;c<3;c++){a[c]-=(255*d+0.5)|0;b[c]+=(255*d+0.5)|0;if(a[c]<0){a[c]=0}if(b[c]>255){b[c]=255}}return{min:new retro.Color(a[0],a[2],a[3]),max:new retro.Color(b[0],b[2],b[3])}};retro.Color.prototype.update=function(){this.int32=this.rgb2int(this.r,this.g,this.b)};